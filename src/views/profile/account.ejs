<%- include('../partials/header.ejs') %>

<body>

  <div class="titulo-admin"> 
    <h1>Administrar Cuenta</h1>
  </div>

  <div>
    <label>Nombre de usuario:</label>
    <span id="username"><%= user.username %></span>
    <button onclick="openModal('username')">Editar</button>
  </div>

  <div>
    <label>Correo:</label>
    <span id="email"><%= user.email %></span>
    <button onclick="openModal('email')">Editar</button>
  </div>

  <div>
    <label>Contraseña:</label>
    <span id="password">********</span>
    <button onclick="openModal('password')">Editar</button>
  </div>

  <!-- Modal -->
  <!-- Modifica tu modal así: -->
<div id="modal" style="display:none;">
  <div id="modal-content">
    <h2 id="modal-title"></h2>
    <form id="modal-form">
      <!-- Inputs dinámicos -->
    </form>
    <button id="resend-code-btn" style="display:none;" type="button">Reenviar código</button>
    <button onclick="closeModal()">Cancelar</button>
    <button type="submit" form="modal-form">Guardar</button>
  </div>
</div>

  <script>
    const formTemplates = {
      username: `
        <label>Nuevo nombre:</label>
        <input type="text" name="newUsername" required>
      `,
      email: `
        <label>Nuevo correo:</label>
        <input type="email" name="newEmail" required>
      `,
      password: `
        <label>Contraseña actual:</label>
        <input type="password" name="oldPassword" required><br>
        <label>Nueva contraseña:</label>
        <input type="password" name="newPassword" required><br>
        <label>Confirmar nueva contraseña:</label>
        <input type="password" name="confirmPassword" required>
      `
    };

    const titles = {
      username: 'Editar Nombre de Usuario',
      email: 'Editar Correo',
      password: 'Editar Contraseña',
      'verify-email': 'Verificar Código de Correo'
    };

    const urls = {
      username: '/user/update-username',
      email: '/user/update-email',
      password: '/user/update-password',
      'verify-email': '/user/verify-email-code'
    };

    function openModal(type) {
      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const form = document.getElementById('modal-form');

      form.dataset.type = type; 
      title.innerText = titles[type];
      form.innerHTML = formTemplates[type] || '';

      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function openCodeModal(newEmail) {
  const modal = document.getElementById('modal');
  const title = document.getElementById('modal-title');
  const form = document.getElementById('modal-form');
  const resendBtn = document.getElementById('resend-code-btn');

  form.dataset.type = 'verify-email';
  title.innerText = titles['verify-email'];
  form.innerHTML = `
    <label>Código de verificación:</label>
    <input type="text" name="codeInput" required>
    <input type="hidden" name="newEmail" value="${newEmail}">
  `;
  
  // Mostrar el botón de reenvío
  resendBtn.style.display = 'block';
  resendBtn.onclick = async () => {
    try {
      const response = await fetch('/user/resend-email-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: newEmail, type: 'verify' })
      });

      if (response.ok) {
        alert('Se ha reenviado el código de verificación a tu correo.');
      } else {
        const errorText = await response.text();
        alert('Error: ' + errorText);
      }
    } catch (error) {
      alert('Error de red: ' + error.message);
    }
  };

  modal.style.display = 'block';
}

    document.getElementById('modal-form').addEventListener('submit', async function (e) {
  e.preventDefault();

  const form = e.target;
  const type = form.dataset.type;
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  let url = urls[type];

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      if (type === 'email') {
        alert('Se envió un código de verificación a tu correo.');
        openCodeModal(data.newEmail); 
      } else if (type === 'verify-email') {
        alert('Correo verificado y actualizado exitosamente.');
        closeModal();
        window.location.reload();
      } else {
        alert('Actualizado correctamente.');
        closeModal();
        window.location.reload();
      }
    } else {
      const errorText = await response.text();
      alert('Error: ' + errorText);
      closeModal();
    }
  } catch (error) {
    alert('Error de red: ' + error.message);
    closeModal();
  }
});
  </script>

</body>

<%- include('../partials/footer.ejs') %>