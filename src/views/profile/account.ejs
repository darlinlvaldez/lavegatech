<%- include('../partials/header.ejs') %>

    <!-- Account -->
    <link type="text/css" rel="stylesheet" href="/css/account.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <body>
    <div class="contenedor-account">
      <div class="titulo-admin">
        <h1>Administrar Cuenta</h1>
      </div>
    </div>

    <div class="contenido-account">
      <div class="informacion">
        <label class="titulo-user">Nombre:</label>
        <span id="username">
          <%= user.username %>
        </span>
        <button class="editar" onclick="openModal('username')">Editar</button>
      </div>

      <div class="informacion">
        <label class="titulo-user">Correo:</label>
        <span id="email">
          <%= user.email %>
        </span>
        <button class="editar" onclick="openModal('email')">Editar</button>
      </div>

      <div class="informacion">
        <label class="titulo-user">Contraseña:</label>
        <span id="password">********</span>
        <button class="editar" onclick="openModal('password')">Editar</button>
      </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal-container" style="display:none;">
      <div id="modal-content" class="modal-contenido">
        <h2 id="modal-title" class="modal-titulo"></h2>
        <div id="verification-message" class="verification-message" style="display:none;"></div>
        <form id="modal-form"></form>

        <div class="contenedor-reenviar">
          <button class="reenviar modal-btn" id="resend-code-btn" style="display:none;" type="button">Reenviar
            Código</button>
        </div>

        <div class="contenedor-acciones">
          <button class="cancelar modal-btn" onclick="closeModal()">Cancelar</button>
          <button class="guardar modal-btn" type="submit" form="modal-form">Guardar</button>
        </div>
      </div>
    </div>

    <script>
      function showNotification(message, isSuccess = true) {
        Toastify({
          text: message,
          duration: 3000,
          close: true,
          gravity: "top",
          position: "right",
          backgroundColor: isSuccess ? "#4CAF50" : "#f44336",
          stopOnFocus: true,
          className: "toast-notification"
        }).showToast();
      }

      const formTemplates = {
        username: `
      <label class="text-modal">Nuevo nombre:</label>
      <input class="modal-input" type="text" name="newUsername" placeholder="Ingresa tu nuevo nombre" required>
      `,

        email: `
      <label class="text-modal">Nuevo correo:</label>
      <input class="modal-input" type="email" name="newEmail" placeholder="ejemplo@gmail.com" required>
      `,

        password: `
      <label class="text-modal">Contraseña actual:</label>
      <input class="modal-input" type="password" name="oldPassword" placeholder="Tu contraseña actual" required>
      <label class="text-modal">Nueva contraseña:</label>
      <input class="modal-input" type="password" name="newPassword" placeholder="Nueva contraseña" required>
      <label class="text-modal">Confirmar nueva contraseña:</label>
      <input class="modal-input" type="password" name="confirmPassword" placeholder="Repite la nueva contraseña" required>
      `
      };

      const titles = {
        username: 'Editar Nombre',
        email: 'Editar Correo',
        password: 'Editar Contraseña',
        'verify-email': 'Verificar Código'
      };

      const urls = {
        username: '/user/update-username',
        email: '/user/update-email',
        password: '/user/update-password',
        'verify-email': '/user/verify-email-code'
      };

      function openModal(type) {
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const form = document.getElementById('modal-form');

        form.dataset.type = type;
        title.innerText = titles[type];
        form.innerHTML = formTemplates[type] || '';

        modal.style.display = 'flex';
      }

      async function openCodeModal(newEmail) {
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const form = document.getElementById('modal-form');
        const resendBtn = document.getElementById('resend-code-btn');
        const verificationMsg = document.getElementById('verification-message');

        form.dataset.type = 'verify-email';
        title.innerText = titles['verify-email'];
        form.innerHTML = `
        <label class="text-modal">Código de verificación:</label>
        <input class="modal-input" type="text" name="codeInput" placeholder="Introduce el código" required>
        <input type="hidden" name="newEmail" value="${newEmail}">
        `;

        verificationMsg.style.display = 'block';
        verificationMsg.innerHTML = `Te hemos enviado un código de verificación a <strong>${newEmail}</strong>`;

        resendBtn.style.display = 'block';
        resendBtn.onclick = async () => {
          try {
            const response = await fetch('/user/resend-email-code', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: newEmail, type: 'verify' })
            });

            if (response.ok) {
              showNotification('Código reenviado exitosamente', true);
              verificationMsg.innerHTML = `Te hemos enviado un nuevo código de verificación a <strong>${newEmail}</strong>`;
            } else {
              const errorText = await response.text();
              showNotification('Error: ' + errorText, false);
            }
          } catch (error) {
            showNotification('Error de red: ' + error.message, false);
          }
        };

        modal.style.display = 'flex';
      }

      function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('resend-code-btn').style.display = 'none';
        document.getElementById('verification-message').style.display = 'none';
      }

      document.getElementById('modal-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          const form = e.target;
          const { type } = form.dataset;
          const data = Object.fromEntries(new FormData(form));

          const response = await fetch(urls[type], {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const responseData = await response.json();

          if (response.ok) {
            showNotification(
              responseData.message ||
                type === 'email' ? 'Se te ha enviado un código al correo' :
                type === 'verify-email' ? 'Correo verificado' : 'Actualizado con exito',
              true
            );
            type === 'email' ? openCodeModal(data.newEmail) : setTimeout(() => {
              closeModal();
              window.location.href = responseData.redirectUrl || '/account';
            }, 2000);
          } else {
            showNotification(
              responseData.error ||
              responseData.message ||
              responseData.errors?.[0]?.message ||
              'Error desconocido',
              false
            );
          }
        } catch (error) {
          showNotification(error.message || 'Error de red', false);
          closeModal();
        }
      });
    </script>

  </body>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <%- include('../partials/footer.ejs') %>