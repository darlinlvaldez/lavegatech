<%- include('../partials/header.ejs') %>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/cart.css">
</head>

<script>
    function cartServer() {
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        
        fetch('/api/procesar-pago', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ carrito })
        }).then(response => response.json())
          .then(data => console.log(data))
          .catch(error => console.error('Error:', error));
    }
</script>

<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8">
                <div class="section-title"><br>
                    <h3 class="title">Carrito</h3>
                </div>
                <span class="text-muted" id="cart-items-count">0 items</span>
                <div id="cart-items-container">
                    <p>No hay productos en el carrito.</p>
                </div>
            </div>
    
            <div class="col-md-4">
                <div class="cart-suma">
                    <h5>SUBTOTAL:</h5>
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between">         
                            <span class="total-price">Total:</span>
                            <span class="total-price" id="cart-total">$0.00</span>
                        </li>
                    </ul>
                        <div class="total-price">
                        <a href="/order" class="btn btn-checkout" onclick="cartServer()">Procesar Pago <i class="fa fa-arrow-circle-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>  
    
    <script>
        function loadCartPage() {
        const cart = JSON.parse(localStorage.getItem('carrito')) || [];
        const container = document.getElementById('cart-items-container');
        const countElement = document.getElementById('cart-items-count');
        const totalElement = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');

        if (cart.length > 0) {
            let html = '';
            let total = 0;
            let totalItems = 0;
            
            cart.forEach(item => {
                const priceWithDiscount = Number(item.precio) * (1 - (item.descuento / 100));
                const itemTotal = priceWithDiscount * item.cantidad;
                total += itemTotal;
                totalItems += 1;                  

                html += `
                <div class="cart-item" data-id="${item.id}"><a href="/product/${item.id}${item.colorSeleccionado ? `?color=${encodeURIComponent(item.colorSeleccionado)}` : ''}">
                        <img src="${item.imagen}" alt="${item.nombre}" class="product-img">
                        <div class="product-info">
                            <h5>${item.nombre}</h5>
                            <span class="product-price">
                                <b>Precio:</b> ${priceWithDiscount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}${item.descuento > 0 ? `
                                    <del class="product-old-price">$${Number(item.precio).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}</del>
                                    <span class="sale">-${item.descuento.toFixed(2)}%</span>
                                ` : ''}
                            </span>
                            </a>
                        </div>
                    <div class="product-items">
                    <span class="label">Color</span>
                    <div class="color-item">
                        ${item.colorSeleccionado ? `<span class="product-color">${item.colorSeleccionado}</span>` : '<span class="product-color">No disponible</span>'}
                    </div>
                </div>
                    <div data-id="${item.id}" data-color="${item.colorSeleccionado}">
                       <div class="qty-cantidad">
                        <span>Cantidad</span>
                        <div class="input-number product-quantity">
                            <input 
                                type="number" 
                                value="${item.cantidad}" 
                                min="1" 
                                max="${item.stock}" 
                                onchange="updateQuantity(this, 0, '${item.id}', '${item.colorSeleccionado}')">
                            <span class="qty-up" onclick="updateQuantity(this.parentNode.querySelector('input'), 1, '${item.id}', '${item.colorSeleccionado}')">+</span>
                            <span class="qty-down" onclick="updateQuantity(this.parentNode.querySelector('input'), -1, '${item.id}', '${item.colorSeleccionado}')">-</span>
                        </div>
                    </div>
                    </div>
                    <div class="col-md-1">
                    <i class="bi bi-trash remove-btn" onclick="deleteProduct('${item.id}', '${item.colorSeleccionado}')"></i>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
            countElement.textContent = `${totalItems} ${totalItems === 1 ? 'producto' : 'productos'}`;
            totalElement.textContent = `$${total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
        } else {
            container.innerHTML = '<p>No hay productos en el carrito.</p>';
            countElement.textContent = '0 productos';
            totalElement.textContent = '$0.00';
        }
    }
    </script>
    
    <%- include('../partials/footer.ejs') %>

</body>
</html>