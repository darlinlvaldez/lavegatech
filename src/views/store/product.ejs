<%- include('../partials/header.ejs') %>	

<link rel="stylesheet" href="/css/vendor/toastify.css">
<link rel="stylesheet" href="/css/store/spec.css">
<link rel="stylesheet" href="/css/utils/ratingTooltip.css">

<!-- SECTION -->
<div class="section">
	<!-- container -->
	<div class="container">
		<div id="product-root"
  			data-variants='<%- JSON.stringify(product.variants) %>'>
			<!-- row -->
			<div class="row">
				<!-- Product main img -->
				<div class="col-md-5 col-md-push-2">
					<div id="product-main-img">
						<% product.variants.forEach(v => { %>
						<div class="product-preview">
							<img src="<%= v.image %>" alt="<%= v.color %>" class="product-img">
						</div>
						<% }) %>
					</div>
				</div>
			<!-- Product thumb imgs -->
			<div class="col-md-2 col-md-pull-5">
				<div id="product-imgs">
					<% product.variants.forEach(v => { %>
					<div class="product-preview"
						onclick="changeVariantById('<%= v.id %>')">
						<img src="<%= v.image %>" alt="<%= v.color %>" class="product-img">
					</div>
					<% }) %>
					</div>
				</div>

	<!-- Product details -->
	<div class="col-md-5">
		<div class="product-details">
			<h2 class="product-name"><%= product.name %> <%= product.specs %></h2>
			<div>
			<div class="product-rating">
			<% for (let i=1; i <=5; i++) { %>
			<% if (i <=Math.floor(product.averageRating)) { %>
			<i class="fa-solid fa-star"></i>
			<% } else if (i - product.averageRating < 1 && i> product.averageRating) { %>
			<i class="fa-regular fa-star-half-stroke"></i>
			<% } else { %>
			<i class="fa-regular fa-star"></i>
			<% } %>
			<% } %>
			</div>
			<a class="review-link">
			(<%= product.totalReviews %>) Reseña(s)
			</a>
			</div>
			<div>
				<h3 class="product-price">
				$<%= Number(product.price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") %>
				<% if (product.discount > 0) { %>
					<del class="product-old-price">
					$<%= Number(product.price / (1 - product.discount / 100)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") %>
					</del>
				<% } %>
				</h3>
				<span class="product-available">
					<p id="stockDisponible">
						Cantidad disponible: <%= currentVariant.stock %>
					</p>
				</span>
			</div>
			<!-- Product options -->
			<% if (product.variants.length > 1) { %>

				<div class="product-options">
					<label>
						Color
						<select class="input-select" id="variantSelect" onchange="changeVariant(this)">
						<% product.variants.forEach(v => { %>
							<option value="<%= v.id %>"
							<%= v.id === product.variantId ? 'selected' : '' %>>
							<%= v.color %>
							</option>
						<% }) %>
						</select>
					</label>
				</div>
				<% } %>
				<div class="add-to-cart">
					<div class="qty-label">
						Cantidad
						<div class="input-number product-quantity">
							<select class="input-select" id="productQuantity">
							<% for(let i = 1; i <= currentVariant.stock; i++) { %>
								<option value="<%= i %>"><%= i %></option>
							<% } %>
							</select>
							 <span id="outOfStockLabel" class="badge bg-danger"
							 style="display:none;">
							AGOTADO
						</div>
					</div>
					<br><br>
					<div class="add-to-cart">
						<button class="add-to-cart-btn" id="add-to-cart-btn" 
						data-id="<%= product.id %>"
						data-variant-id="<%= currentVariant.id %>"
						data-color="<%= currentVariant.color %>"
						data-stock="<%= currentVariant.stock %>"
						data-ram="<%= product.ram %>"
						data-specs="<%= product.specs %>"
						data-name="<%= product.name %>"
						data-price="<%= product.price %>"
						data-tax="<%= product.tax %>"
						data-discount="<%= product.discount %>"
						data-image="<%= product.image %>">
						<i class="fa fa-shopping-cart"></i> Añadir al carrito
						</button>
					</div>
				</div>
				<ul class="product-btns">
				<li>
				<a role="button" class="add-to-wishlist" 
					data-product-id="<%= product.id %>" 
					data-variant-id="<%= product.variantId %>">
				<i class="fa fa-heart-o"></i> Favoritos</a></li>
				<% if (product.itsMobile) { %>
				<li><a href="#" class="add-to-compare" data-id="<%= product.id %>">
					<i class="fa-solid fa-arrow-right-arrow-left"></i> Comparar</a></li>
				<% } %>
				</ul>

				<% if (['moviles', 'smarttv', 'laptops', 'consolas', 'tablets', 'otros'].includes(product.category.toLowerCase())) { %>
				<ul class="product-links">
				<li>Categoría:</li>
				<li>
				<a href="/store/1?category=<%= product.categoryId %>">
					<%= product.category.toLowerCase() === 'moviles' ? 'Móviles' :
					product.category.charAt(0).toUpperCase() + product.category.slice(1) %>
				</a>
				</li>
				</ul>
				<% } %>

				<ul class="product-links">
				<li>Compartir:</li>
				<li>
					<a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent('http://localhost:3000' + currentUrl) %>" target="_blank">
					<i class="fa-brands fa-facebook-f"></i>
					</a>
				</li>
				<li>
					<a href="https://api.whatsapp.com/send?text=<%= encodeURIComponent('http://localhost:3000' + currentUrl) %>" target="_blank">
						<i class="fa-brands fa-whatsapp"></i>
					</a>
				</li>
				<li>
					<a href="https://twitter.com/intent/tweet?text=<%= encodeURIComponent('Mira este product: ' + product.name) %>&url=<%= encodeURIComponent('http://localhost:3000' + currentUrl) %>" target="_blank">
					<i class="fa-brands fa-x-twitter"></i>
					</a>
				</li>
				<li>
					<a href="https://t.me/share/url?url=<%= encodeURIComponent('http://localhost:3000' + currentUrl) %>" target="_blank">
						<i class="fa-brands fa-telegram"></i>
					</a>
				</li>
				<li>
					<a href="mailto:?subject=<%= encodeURIComponent('Mira este product: ' + product.name) %>&body=<%= encodeURIComponent('Te comparto este product que encontré: http://localhost:3000' + currentUrl) %>">
					<i class="fa-solid fa-envelope"></i>
					</a>
				</li>
				</ul>
			</div>
		</div>
		<!-- /Product details -->
  
		<!-- Product tab -->
		<div class="col-md-12">
			<div id="product-tab">
				<!-- product tab nav -->
				<ul class="tab-nav">
					<li class="active"><a data-toggle="tab" href="#tab1">Descripción</a></li>
					 <% if (product.itsMobile) { %>
					<li><a data-toggle="tab" href="#tab2">Detalles</a></li>
					<% } %>
					<li><a data-toggle="tab" href="#tab3">Reseñas (<%= product.totalReviews %>)</a></li>
				</ul>
				<!-- /product tab nav -->

				<!-- product tab content -->
				<div class="tab-content">
					<!-- tab1  -->
					<div id="tab1" class="tab-pane fade in active">
						<div class="row">
							<div class="col-md-12">
								<p><%= product.description %></p>
							</div>
						</div>
					</div>
					<!-- /tab1  -->

					<!-- tab2  -->
					<% if (product.itsMobile) { %>
					<div id="tab2" class="tab-pane fade in">
						<div class="row">
							<div class="col-md-12">
								<div class="device-card">
									<% devices.forEach(device=> { %>
									<div class="specs-grid">
										<div class="spec-item spec-header">Pantalla:</div>
										<div class="spec-item spec-value">
											<%= device.screen_size %>" <%= device.screen_type %><br>
											<%= device.screen_resolution %><br>
											<%= device.screen_refresh_rate %>Hz
										</div>

										<div class="spec-item spec-header">Procesador:</div>
										<div class="spec-item spec-value">
											<%= device.processor_name %><br>
											<%= device.processor_cores %> núcleos<br>
											<%= device.processor_speed %>
										</div>

										<div class="spec-item spec-header">GPU:</div>
										<div class="spec-item spec-value">
											<%= device.gpu_model %><br>
											<%= device.gpu_cores %> núcleos
										</div>

										<div class="spec-item spec-header">RAM:</div>
										<div class="spec-item spec-value"><%= device.ram_capacities %></div>

										<div class="spec-item spec-header">Almacenamiento:</div>
										<div class="spec-item spec-value"><%= device.storage_capacities %></div>

										<div class="spec-item spec-header">Cámara:</div>
										<div class="spec-item spec-value">
											Principal: <%= device.main_camera %><br>
											Frontal: <%= device.selfie_camera %><br>
											Video: <%= device.video_recording %>
										</div>

										<div class="spec-item spec-header">Batería:</div>
										<div class="spec-item spec-value">
											<%= device.battery_capacity %> mAh<br>
											<%= device.battery_type %><br>
											<% if (device.fast_charging) { %>
												Carga rápida: <%= device.fast_charging %><br>
											<% } %>
											<% if (device.wireless_charging) { %>
												Carga inalámbrica
											<% } %>
										</div>

										<div class="spec-item spec-header">Conectividad:</div>
										<div class="spec-item spec-value">
											<%= device.network %><br>
											WiFi: <%= device.wifi %><br>
											Bluetooth: <%= device.bluetooth %>
											<% if (device.nfc) { %><br>NFC<% } %>
										</div>

										<div class="spec-item spec-header">Dimensiones:</div>
										<div class="spec-item spec-value">
											<%= device.height %> x <%= device.width %> x <%= device.thickness %> mm<br>
											Peso: <%= device.weight %> g
										</div>
									<% }) %>
									</div>
								</div>
							</div>
						</div>
					</div>
					<% } %>
					<!-- /tab2  -->

					<!-- tab3  -->
					<div id="tab3" class="tab-pane fade in">
						<div class="row">
							<!-- Rating -->
							<div class="col-md-3">
								<div id="rating">
									<div class="rating-avg">
										<span><%= product.averageRating.toFixed(1) %></span>
										<div class="rating-stars">
											<% const avgRating = product.averageRating || 0; %>
											<% for(let i = 1; i <= 5; i++) { %>
												<% if(i <= Math.floor(avgRating)) { %>
													<i class="fa-solid fa-star"></i>
												<% } else if(i === Math.ceil(avgRating) && avgRating % 1 > 0.3) { %>
													<i class="fa-regular fa-star-half-stroke"></i>
												<% } else { %>
													<i class="fa-regular fa-star"></i>
												<% } %>
											<% } %>
										</div>
									</div>
									<ul class="rating">
										<% 
										const distribution = {};
										for(let i = 1; i <= 5; i++) {
											distribution[i] = 0;
										}
										
										product.ratingDistribution.forEach(item => {
											distribution[item.rating] = item.count;
										});
										
										const totalReviews = product.totalReviews;
										%>
										
										<% for(let stars = 5; stars >= 1; stars--) { %>
											<li>
												<div class="rating-stars">
													<% for(let i = 1; i <= 5; i++) { %>
														<% if(i <= stars) { %>
															<i class="fa-solid fa-star"></i>
														<% } else { %>
															<i class="fa-regular fa-star"></i>
														<% } %>
													<% } %>
												</div>
												<div class="rating-progress">
													<div style="width: <%= totalReviews > 0 ? (distribution[stars] / totalReviews * 100) : 0 %>%;"></div>
												</div>
												<span class="sum"><%= distribution[stars] %></span>
											</li>
										<% } %>
									</ul>
								</div>
							</div>
							<!-- /Rating -->

							<!-- Reviews -->
							<div class="col-md-6">
								<div id="reviews" data-product-id="<%= product.id %>"></div>
							</div>
							<!-- /Reviews -->

							<!-- Review Form -->
							<% if(typeof user !== 'undefined' && user) { %>            
								<div class="col-md-3">
											<div id="review-form">
												<form class="review-form" id="reviewForm">
													<input type="hidden" name="productId" value="<%= product.id %>">
													<input type="hidden" name="reviewId" id="reviewId" value="">
													<textarea class="input" name="review" id="reviewInput" placeholder="Tu reseña" required></textarea>
													<input type="hidden" name="rating" id="ratingInput">
													<div class="input-rating">
														<span>Tu calificación: </span>
														<div class="stars">
															<input id="star5" name="rating" value="5" type="radio" required><label for="star5"></label>
															<input id="star4" name="rating" value="4" type="radio"><label for="star4"></label>
															<input id="star3" name="rating" value="3" type="radio"><label for="star3"></label>
															<input id="star2" name="rating" value="2" type="radio"><label for="star2"></label>
															<input id="star1" name="rating" value="1" type="radio"><label for="star1"></label>
														</div>
													</div>
													<button type="submit" class="primary-btn">Enviar</button>
												</form>
											</div>
										</div>
									<% } else { %>
									<div class="col-md-3">
										<p>Debes <a href="/login">iniciar sesión</a> para dejar una reseña.</p>
									</div>
								<% } %>
								<!-- /Review Form -->
							</div>
						</div>
						<!-- /tab3  -->
					</div>
					<!-- /product tab content  -->
				</div>
			</div>
			<!-- /product tab -->
		</div>
	<!-- /row -->
	</div>
	<!-- /container -->
</div>
<!-- /SECTION -->

	<!-- Section -->
	<div class="section">
		<!-- container -->
		<div class="container">
			<!-- row -->
			<div class="row">
				<div class="col-md-12">
					<div class="section-title text-center">
						<h3 class="title">productos que podrían interesarte</h3>
					</div>
				</div>
				<% if (productRelated && productRelated.length > 0) { %>
					<% productRelated.forEach(product => { %>
						<!-- product -->
						<div class="col-md-3 col-xs-6">
							<div class="product">
								<div class="product-img">
									<a href="/product/<%= product.id %>?color=<%= product.color %>">
										<img src="<%= product.image %>" alt="<%= product.name %>">
										<div class="product-label">
                                            <% if (product.discount > 0) { %>
                                            <span class="sale">-<%= product.discount %>%</span>
                                            <% } %>
                                            <% if (product.itsNew) { %>
                                            <span class="new">Nuevo</span>
                                            <% } %>
                                        </div>
								</div>
								<div class="product-body">
									<p class="product-category">
										<%= product.category === 'moviles' ? 'Móviles' : product.category.charAt(0).toUpperCase() + product.category.slice(1) %>
									</p>
									<h3 class="product-name">
											<%= product.name %> <%= product.specs %>
										</h3>
									<h4 class="product-price">
									$<%= Number(product.price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") %>
									<% if (product.discount > 0) { %>
										<del class="product-old-price">$<%= Number(product.price / (1 - product.discount / 100)).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></del>
									<% } %>
                                    </h4></a>
									<div class="product-rating clickable-rating" data-product-id="<%= product.id %>">
                                        <% for (let i = 1; i <= 5; i++) { %>
                                            <% if (i <= Math.floor(product.averageRating)) { %>
                                                <i class="fa-solid fa-star"></i>
                                            <% } else if (i - product.averageRating < 1 && i > product.averageRating) { %>
                                                <i class="fa-regular fa-star-half-stroke"></i>
                                            <% } else { %>
                                                <i class="fa-regular fa-star"></i>
                                            <% } %>
                                        <% } %>
                                        <div class="rating-tooltip"></div>
                                    </div>

                                    <div class="product-btns">
                                        <button class="add-to-wishlist" 
                                                data-product-id="<%= product.id %>" 
                                                data-product-color="<%= product.color %>">
                                            <i class="fa-regular fa-heart"></i>  
                                            <span class="tooltipp">Favoritos</span>
                                        </button>

                                        <% if (product.itsMobile) { %>
                                            <button class="add-to-compare" data-id="<%= product.id %>">
                                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                                                <span class="tooltipp">Comparar</span>
                                            </button>
                                        <% } %>
                                    </div>
								</div>
							</div>
						</div>
						<!-- /product -->
					<% }); %>
				<% } else { %>
					<p>No hay products relacionados disponibles en esta categoría.</p>
				<% } %>
			</div>
		</div>
	</div>
	</div>
	<!-- /row -->
	</div>
	<!-- /container -->
	</div>
	<!-- /Section -->

	<%- include('../partials/footer.ejs') %>

	</body>
	<script src="/js/utils/ratingTab.js" type="module"></script>
	<script src="/js/utils/buttonComparison.js"></script>
	<script src="/js/store/stockColor.js"></script>
    <script src="/js/store/cart/cart.js" type="module"></script>
	<script src="/js/store/rating.js" type="module"></script>
	<script src="/js/vendor/toastify.js"></script>
	<script src="https://unpkg.com/feather-icons"></script>

	</html>